name: Publish

on:
  push:
    branches:
      - feat/publish_package

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: ["3.10"]

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install ".[dev]"

      - name: Run Test
        env:
          GITHUB_ORG: ${{ secrets.GH_ORG }}
          GITHUB_TOKEN: ${{ secrets.ADMIN_GITHUB_TOKEN }}
          PYTHONPATH: ${GITHUB_WORKSPACE}
        run: |
          pytest

  publish:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.ADMIN_GITHUB_TOKEN }}

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      # ADD THESE DEBUGGING STEPS:
      - name: Debug Git Information
        run: |
          echo "--- Current Directory ---"
          pwd
          echo "--- Git Status ---"
          git status
          echo "--- Current Branch ---"
          git branch --show-current
          echo "--- Remote URLs ---"
          git remote -v
          echo "--- Fetching all tags from remote again (force) ---"
          echo "# Forcing can sometimes help with CI caching or sparse checkouts if any happened before"
          git fetch --all --tags --force
          echo "--- All Local Tags ---"
          git tag -l
          echo "--- Recent Commits on Current Branch (with decoration) ---"
          git log --decorate --oneline -n 30 
          echo "--- Details for v2.1.0 tag (if it exists locally) ---"
          git show v2.1.0 --pretty=fuller || echo "Error: v2.1.0 tag not found by 'git show' in CI"
          echo "--- python-semantic-release version ---"
          pip install python-semantic-release # Ensure it's installed if not already via action's env
          python -m semantic_release --version

      - name: Python Semantic Release
        uses: python-semantic-release/python-semantic-release@v7.34.6
        with:
          github_token: ${{ secrets.ADMIN_GITHUB_TOKEN }}
          pypi_token: ${{ secrets.PYPI_TOKEN }}
